# project-root/nginx/default.conf

server {
    listen 80;
    server_name localhost;

    # ドキュメントルートは、通常は /var/www/html などですが、
    # ユーザーディレクトリの公開をメインとするため、ここはコメントアウトまたは無視されます。
    # root /usr/share/nginx/html; 

    # index index.html index.htm index.nginx-debian.html;
    # PHPファイルを処理対象に追加
    index index.html index.htm index.php index.nginx-debian.html;

    # 元の location / {} ブロック
    location / {
        # ここは基本的にデフォルトのまま
        try_files $uri $uri/ =404;
    }

    # 元の Dockerfile に追加された設定

    # .ht ファイルのアクセス拒否
    location ~ /\.ht {
        deny all;
    }

    # ユーザーディレクトリ内のPHPファイル (~/user/file.php) の処理
    location ~ ^/~([^/]+)/(.+\.php)$ {
        alias /home/$1/public_html/$2;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $request_filename;
        # ⭐ 転送先を TCP 接続に変更 ⭐
        fastcgi_pass app:9000;  # サービス名:ポート番号
    }

    # 標準のPHPファイルの処理 (この設定は /var/www/html/ など標準ルート用。なくても動くが念のため残す)
    location ~ \.php$ {
        include fastcgi_params;
        # ⭐ 転送先を TCP 接続に変更 ⭐
        fastcgi_pass app:9000;
    }

    # ユーザーディレクトリ (~/user/...) のファイル/ディレクトリ表示
    location ~ ^/~(.+?)(/.*)?$ {
        # /home/sspuser/public_html/ にマッピング
        alias /home/$1/public_html$2;
        autoindex on;
    }
}